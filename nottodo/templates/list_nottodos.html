{% extends 'base.html' %}

{% block title %}My Not To Dos{% endblock %}

{% block content %}
<h2 class="mt-4">My Not To Dos</h2>
<a href="{% url 'add_nottodo' %}" class="btn btn-primary mb-3">Add Not To Do</a>

<!-- Context Filter Buttons -->
<div class="btn-group mb-3" role="group" aria-label="Filter by context">
  <a href="{% url 'list_nottodos' %}?context=All" class="btn btn-secondary {% if context_filter == 'All' %}active{% endif %}">All</a>
  <a href="{% url 'list_nottodos' %}?context=Home" class="btn btn-secondary {% if context_filter == 'Home' %}active{% endif %}">Home</a>
  <a href="{% url 'list_nottodos' %}?context=Work" class="btn btn-secondary {% if context_filter == 'Work' %}active{% endif %}">Work</a>
  <a href="{% url 'list_nottodos' %}?context=Other" class="btn btn-secondary {% if context_filter == 'Other' %}active{% endif %}">Other</a>
</div>

<div id="calendar" class="mb-4"></div>

<div class="card-list">
    {% for nottodo in nottodos %}
    <div class="card nottodo-card mb-3">
        <div class="card-body">
            <h5 class="card-title">{{ nottodo.title }}</h5>
            <p class="card-text">{{ nottodo.description }}</p>
            <p class="card-text"><small class="text-muted">{{ nottodo.context }}</small></p>
            <p class="card-text"><small class="text-muted">{{ nottodo.scheduled_start_time|date:"D, d M Y H:i" }} - {{ nottodo.scheduled_end_time|date:"D, d M Y H:i" }}</small></p>
            <p class="card-text"><small class="text-muted">{{ nottodo.get_repeat_display }}</small></p>
            <a href="{% url 'update_nottodo' nottodo.pk %}" class="btn btn-warning btn-sm">Edit</a>
            <a href="{% url 'delete_nottodo' nottodo.pk %}" class="btn btn-danger btn-sm">Delete</a>
            <a href="{% url 'share_nottodo' nottodo.pk %}" class="btn btn-primary btn-sm">Share</a>
        </div>
    </div>
    {% empty %}
    <p>No Not To Dos found.</p>
    {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = $('#calendar').fullCalendar({
      events: '/nottodos/events/',  
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      editable: true,
      selectable: true,
      viewRender: function(view) {
        var month = view.intervalStart.month();
        var calendarEl = document.getElementById('calendar');
        calendarEl.classList.remove('calendar-winter', 'calendar-spring', 'calendar-summer', 'calendar-autumn');

        if (month == 11 || month == 0 || month == 1) {
          calendarEl.classList.add('calendar-winter');
        } else if (month >= 2 && month <= 4) {
          calendarEl.classList.add('calendar-spring');
        } else if (month >= 5 && month <= 7) {
          calendarEl.classList.add('calendar-summer');
        } else if (month >= 8 && month <= 10) {
          calendarEl.classList.add('calendar-autumn');
        }

        fetchHolidays(view.start, view.end);
      }
    });

    function fetchHolidays(start, end) {
      var apiKey = 'a33b30f7-3cba-400c-864b-5676f9654887';
      var country = 'DE';  // Change to your country code if needed YOU NEED TO ACCESS EXTENAL WEBSITE > IN PROGRESS JONATHAN UPDATE
      var startDate = start.format('YYYY-MM-DD');
      var endDate = end.format('YYYY-MM-DD');
      var url = `https://holidayapi.com/v1/holidays?key=${apiKey}&country=${country}&year=${start.year()}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          var holidays = data.holidays.map(holiday => ({
            title: holiday.name,
            start: holiday.date,
            backgroundColor: 'red',  // Custom color for holidays
            borderColor: 'red',
            textColor: 'white'
          }));
          $('#calendar').fullCalendar('addEventSource', holidays);
        })
        .catch(error => console.error('Error fetching holidays:', error));
    }
  });
</script>

{% endblock %}